name: Upload Website (Refactored to use Custom Action)
on:
  push:
    branches:
    - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    # Define common environment variables for all steps in this job
    env:
      AWS_REGION: ${{ secrets.AWS_REGION }}
      AWS_S3_BUCKET: ${{ secrets.AWS_S3_BUCKET }}
    
    steps:
      - name: 1. Git checkout
        uses: actions/checkout@v3

      # --- REMOVED REDUNDANT CHECKOUT HERE ---

      - name: 2. Configure AWS credentials from AWS account
        uses: aws-actions/configure-aws-credentials@v1
        with:
          # Note: The original had a typo '][' which is assumed to be corrected here
          role-to-assume: ${{ secrets.AWS_ROLE }}
          aws-region: ${{ env.AWS_REGION }} # Using env variable defined above
          role-session-name: GitHub-OIDC-frontend
          

      - name: 3. Deploy to S3 using Custom Composite Action
        # Assuming your custom action is located at the repository root
        # and has been checked out by step 1.
        uses: ./ # Use the local path to your custom composite action
        with:
          args: --follow-symlinks --exclude '.git/*' --exclude '.github/*'
        # The action uses the AWS_REGION and AWS_S3_BUCKET from the job-level 'env' block

      - name: 4. Invalidate CloudFront
        uses: chetan/invalidate-cloudfront-action@v2
        env:
          DISTRIBUTION: ${{ secrets.AWS_CF_DISTRIBUTION_ID }}
          # Invalidate all files (/*) is generally safer than /index.html only
          PATHS: "/*"